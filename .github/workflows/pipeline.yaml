name: Image push to ACR - CI/CD Pipeline

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ main ]

env:
  ACR_REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    #- name: Set up Java and Maven
     # uses: actions/setup-java@v3
      #with:
       # java-version: '17'
        #distribution: 'temurin'
        #cache: 'maven'  # This sets up Maven and caches dependencies

    - name: Log in to ACR
      run: echo "${{ secrets.ACR_PASSWORD }}" | docker login $ACR_REGISTRY -u ${{ secrets.ACR_USERNAME }} --password-stdin

    - name: Build & Push Docker Images
      run: |
        set -e

        services=("shipping" "cart" "catalog" "dispatch" "payment" "ratings" "user")

        for service in "${services[@]}"; do
          echo "Building $service..."

          mvn -f E_commerce_project/$service/pom.xml clean package -DskipTests

          docker build -t $service:latest E_commerce_project/$service

          docker tag $service:latest $ACR_REGISTRY/$service:latest
          docker push $ACR_REGISTRY/$service:latest

          echo "$service image pushed to $ACR_REGISTRY"
        done
