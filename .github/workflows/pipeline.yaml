name: Image push to ACR and JFrog - CI/CD Pipeline

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ main ]

env:
  ACR_REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Maven
      uses: s4u/setup-maven-action@v1
      with:
        maven-version: '3.8.8'  # Or use the latest stable version

    - name: Log in to ACR
      run: echo "${{ secrets.ACR_PASSWORD }}" | docker login $ACR_REGISTRY -u ${{ secrets.ACR_USERNAME }} --password-stdin

    - name: Build & Push Docker Images
      run: |
        set -e  # Exit on error

        services=("shipping" "cart" "catalog" "dispatch" "payment" "ratings" "user")  # Add more if needed

        for service in "${services[@]}"; do
          echo "Building $service..."

          # Build the JAR
          mvn -f E_commerce_project/$service/pom.xml clean package -DskipTests

          # Build Docker image
          docker build -t $service:latest E_commerce_project/$service

          # Push to ACR
          docker tag $service:latest $ACR_REGISTRY/$service:latest
          docker push $ACR_REGISTRY/$service:latest

          echo "$service image pushed to $ACR_REGISTRY"
        done
